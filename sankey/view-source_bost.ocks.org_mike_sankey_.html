
<!-- saved from url=(0033)http://bost.ocks.org/mike/sankey/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><div class="line-gutter-backdrop"></div><table><tbody><tr><td class="line-number" value="1"></td><td class="line-content"><span class="html-doctype">&lt;!DOCTYPE html&gt;</span></td></tr><tr><td class="line-number" value="2"></td><td class="line-content"><span class="html-tag">&lt;html <span class="html-attribute-name">class</span>="<span class="html-attribute-value">ocks-org do-not-copy</span>"&gt;</span></td></tr><tr><td class="line-number" value="3"></td><td class="line-content"><span class="html-tag">&lt;meta <span class="html-attribute-name">charset</span>="<span class="html-attribute-value">utf-8</span>"&gt;</span></td></tr><tr><td class="line-number" value="4"></td><td class="line-content"><span class="html-tag">&lt;title&gt;</span>Sankey Diagram<span class="html-tag">&lt;/title&gt;</span></td></tr><tr><td class="line-number" value="5"></td><td class="line-content"><span class="html-tag">&lt;style&gt;</span></td></tr><tr><td class="line-number" value="6"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="7"></td><td class="line-content">@import url(../style.css?aea6f0a);</td></tr><tr><td class="line-number" value="8"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="9"></td><td class="line-content">#chart {</td></tr><tr><td class="line-number" value="10"></td><td class="line-content">  height: 500px;</td></tr><tr><td class="line-number" value="11"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="12"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="13"></td><td class="line-content">.node rect {</td></tr><tr><td class="line-number" value="14"></td><td class="line-content">  cursor: move;</td></tr><tr><td class="line-number" value="15"></td><td class="line-content">  fill-opacity: .9;</td></tr><tr><td class="line-number" value="16"></td><td class="line-content">  shape-rendering: crispEdges;</td></tr><tr><td class="line-number" value="17"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="18"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="19"></td><td class="line-content">.node text {</td></tr><tr><td class="line-number" value="20"></td><td class="line-content">  pointer-events: none;</td></tr><tr><td class="line-number" value="21"></td><td class="line-content">  text-shadow: 0 1px 0 #fff;</td></tr><tr><td class="line-number" value="22"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="23"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="24"></td><td class="line-content">.link {</td></tr><tr><td class="line-number" value="25"></td><td class="line-content">  fill: none;</td></tr><tr><td class="line-number" value="26"></td><td class="line-content">  stroke: #000;</td></tr><tr><td class="line-number" value="27"></td><td class="line-content">  stroke-opacity: .2;</td></tr><tr><td class="line-number" value="28"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="29"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="30"></td><td class="line-content">.link:hover {</td></tr><tr><td class="line-number" value="31"></td><td class="line-content">  stroke-opacity: .5;</td></tr><tr><td class="line-number" value="32"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="33"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="34"></td><td class="line-content"><span class="html-tag">&lt;/style&gt;</span></td></tr><tr><td class="line-number" value="35"></td><td class="line-content"><span class="html-tag">&lt;body&gt;</span></td></tr><tr><td class="line-number" value="36"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="37"></td><td class="line-content"><span class="html-tag">&lt;header&gt;</span></td></tr><tr><td class="line-number" value="38"></td><td class="line-content">  <span class="html-tag">&lt;aside&gt;</span>May 22, 2012<span class="html-tag">&lt;/aside&gt;</span></td></tr><tr><td class="line-number" value="39"></td><td class="line-content">  <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://bost.ocks.org/mike/">../</a>" <span class="html-attribute-name">rel</span>="<span class="html-attribute-value">author</span>"&gt;</span>Mike Bostock<span class="html-tag">&lt;/a&gt;</span></td></tr><tr><td class="line-number" value="40"></td><td class="line-content"><span class="html-tag">&lt;/header&gt;</span></td></tr><tr><td class="line-number" value="41"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="42"></td><td class="line-content"><span class="html-tag">&lt;h1&gt;</span>Sankey Diagrams<span class="html-tag">&lt;/h1&gt;</span></td></tr><tr><td class="line-number" value="43"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="44"></td><td class="line-content"><span class="html-tag">&lt;p <span class="html-attribute-name">id</span>="<span class="html-attribute-value">chart</span>"&gt;</span></td></tr><tr><td class="line-number" value="45"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="46"></td><td class="line-content"><span class="html-tag">&lt;aside&gt;</span>Drag to rearrange nodes.<span class="html-tag">&lt;/aside&gt;</span></td></tr><tr><td class="line-number" value="47"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="48"></td><td class="line-content"><span class="html-tag">&lt;p <span class="html-attribute-name">class</span>="<span class="html-attribute-value">attribution</span>"&gt;</span>Source: <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://www.decc.gov.uk/en/content/cms/tackling/2050/calculator_on/calculator_on.aspx">http://www.decc.gov.uk/en/content/cms/tackling/2050/calculator_on/calculator_on.aspx</a>"&gt;</span>Department of Energy &amp; Climate Change<span class="html-tag">&lt;/a&gt;</span>, <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://tamc.github.com/Sankey/">http://tamc.github.com/Sankey/</a>"&gt;</span>Tom Counsell<span class="html-tag">&lt;/a&gt;</span>.</td></tr><tr><td class="line-number" value="49"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="50"></td><td class="line-content"><span class="html-tag">&lt;aside&gt;</span>Sankey diagrams are closely related to <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://en.wikipedia.org/wiki/Alluvial_diagram">http://en.wikipedia.org/wiki/Alluvial_diagram</a>"&gt;</span>alluvial diagrams<span class="html-tag">&lt;/a&gt;</span>, which show how network structure changes over time.<span class="html-tag">&lt;/aside&gt;</span></td></tr><tr><td class="line-number" value="51"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="52"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span><span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://en.wikipedia.org/wiki/Sankey_diagram">http://en.wikipedia.org/wiki/Sankey_diagram</a>"&gt;</span>Sankey diagrams<span class="html-tag">&lt;/a&gt;</span> visualize the magnitude of flow between nodes in a network. This intricate diagram shows a possible scenario for UK energy production and consumption in 2050: energy <span class="html-tag">&lt;b&gt;</span>supplies<span class="html-tag">&lt;/b&gt;</span> are on the left, and <span class="html-tag">&lt;b&gt;</span>demands<span class="html-tag">&lt;/b&gt;</span> are on the right. Intermediate nodes group related forms of production and show how energy is converted and transmitted before it is consumed (or lost!). The thickness of each link encodes the amount of flow from source to target.</td></tr><tr><td class="line-number" value="53"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="54"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>This example is built with <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://d3js.org/">http://d3js.org</a>"&gt;</span>D3<span class="html-tag">&lt;/a&gt;</span>’s <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="https://github.com/d3/d3-plugins/tree/master/sankey">https://github.com/d3/d3-plugins/tree/master/sankey</a>"&gt;</span>Sankey plugin<span class="html-tag">&lt;/a&gt;</span>. The plugin takes as input the nodes and weighted links, computing positions via <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://en.wikipedia.org/wiki/Gauss%E2%80%93Seidel_method">http://en.wikipedia.org/wiki/Gauss–Seidel_method</a>"&gt;</span>iterative relaxation<span class="html-tag">&lt;/a&gt;</span>. After fixing the horizontal position of each node, the algorithm starts from the sources on the left, positioning downstream nodes so as to minimize link distance. A reverse pass is then made from right-to-left, and then the entire process is repeated several times. Overlapping nodes are shifted to avoid collision.</td></tr><tr><td class="line-number" value="55"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="56"></td><td class="line-content"><span class="html-tag">&lt;aside&gt;</span>The d3.sankey API is similar to D3’s <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://mbostock.github.com/d3/ex/force.html">http://mbostock.github.com/d3/ex/force.html</a>"&gt;</span>force-directed graph<span class="html-tag">&lt;/a&gt;</span> layout, which is another type of network visualization.<span class="html-tag">&lt;/aside&gt;</span></td></tr><tr><td class="line-number" value="57"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="58"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>The fully automatic layout is convenient for rapid visualization—positioning nodes manually is tedious! However, the algorithm is not perfect; links are drawn with partial transparency to highlight crossings. To improve readability and further disambiguate links, this example also lets you reposition nodes interactively. The algorithm could be improved in the future, say to minimize link crossing or to support loopback in cyclical networks.</td></tr><tr><td class="line-number" value="59"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="60"></td><td class="line-content"><span class="html-tag">&lt;p&gt;</span>Many thanks to Tom Counsell, whose <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://tamc.github.com/Sankey/">http://tamc.github.com/Sankey/</a>"&gt;</span>Sankey library<span class="html-tag">&lt;/a&gt;</span> provided inspiration for this example.</td></tr><tr><td class="line-number" value="61"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="62"></td><td class="line-content"><span class="html-tag">&lt;footer&gt;</span></td></tr><tr><td class="line-number" value="63"></td><td class="line-content">  <span class="html-tag">&lt;aside&gt;</span>May 22, 2012<span class="html-tag">&lt;/aside&gt;</span></td></tr><tr><td class="line-number" value="64"></td><td class="line-content">  <span class="html-tag">&lt;a <span class="html-attribute-name">href</span>="<a class="html-attribute-value html-external-link" target="_blank" href="http://bost.ocks.org/mike/">../</a>" <span class="html-attribute-name">rel</span>="<span class="html-attribute-value">author</span>"&gt;</span>Mike Bostock<span class="html-tag">&lt;/a&gt;</span></td></tr><tr><td class="line-number" value="65"></td><td class="line-content"><span class="html-tag">&lt;/footer&gt;</span></td></tr><tr><td class="line-number" value="66"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="67"></td><td class="line-content"><span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="https://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js">https://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js</a>" <span class="html-attribute-name">charset</span>="<span class="html-attribute-value">utf-8</span>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="68"></td><td class="line-content"><span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://bost.ocks.org/mike/sankey/sankey.js">sankey.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="69"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="70"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="71"></td><td class="line-content">var margin = {top: 1, right: 1, bottom: 6, left: 1},</td></tr><tr><td class="line-number" value="72"></td><td class="line-content">    width = 960 - margin.left - margin.right,</td></tr><tr><td class="line-number" value="73"></td><td class="line-content">    height = 500 - margin.top - margin.bottom;</td></tr><tr><td class="line-number" value="74"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="75"></td><td class="line-content">var formatNumber = d3.format(",.0f"),</td></tr><tr><td class="line-number" value="76"></td><td class="line-content">    format = function(d) { return formatNumber(d) + " TWh"; },</td></tr><tr><td class="line-number" value="77"></td><td class="line-content">    color = d3.scale.category20();</td></tr><tr><td class="line-number" value="78"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="79"></td><td class="line-content">var svg = d3.select("#chart").append("svg")</td></tr><tr><td class="line-number" value="80"></td><td class="line-content">    .attr("width", width + margin.left + margin.right)</td></tr><tr><td class="line-number" value="81"></td><td class="line-content">    .attr("height", height + margin.top + margin.bottom)</td></tr><tr><td class="line-number" value="82"></td><td class="line-content">  .append("g")</td></tr><tr><td class="line-number" value="83"></td><td class="line-content">    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");</td></tr><tr><td class="line-number" value="84"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="85"></td><td class="line-content">var sankey = d3.sankey()</td></tr><tr><td class="line-number" value="86"></td><td class="line-content">    .nodeWidth(15)</td></tr><tr><td class="line-number" value="87"></td><td class="line-content">    .nodePadding(10)</td></tr><tr><td class="line-number" value="88"></td><td class="line-content">    .size([width, height]);</td></tr><tr><td class="line-number" value="89"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="90"></td><td class="line-content">var path = sankey.link();</td></tr><tr><td class="line-number" value="91"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="92"></td><td class="line-content">d3.json("energy.json", function(energy) {</td></tr><tr><td class="line-number" value="93"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="94"></td><td class="line-content">  sankey</td></tr><tr><td class="line-number" value="95"></td><td class="line-content">      .nodes(energy.nodes)</td></tr><tr><td class="line-number" value="96"></td><td class="line-content">      .links(energy.links)</td></tr><tr><td class="line-number" value="97"></td><td class="line-content">      .layout(32);</td></tr><tr><td class="line-number" value="98"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="99"></td><td class="line-content">  var link = svg.append("g").selectAll(".link")</td></tr><tr><td class="line-number" value="100"></td><td class="line-content">      .data(energy.links)</td></tr><tr><td class="line-number" value="101"></td><td class="line-content">    .enter().append("path")</td></tr><tr><td class="line-number" value="102"></td><td class="line-content">      .attr("class", "link")</td></tr><tr><td class="line-number" value="103"></td><td class="line-content">      .attr("d", path)</td></tr><tr><td class="line-number" value="104"></td><td class="line-content">      .style("stroke-width", function(d) { return Math.max(1, d.dy); })</td></tr><tr><td class="line-number" value="105"></td><td class="line-content">      .sort(function(a, b) { return b.dy - a.dy; });</td></tr><tr><td class="line-number" value="106"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="107"></td><td class="line-content">  link.append("title")</td></tr><tr><td class="line-number" value="108"></td><td class="line-content">      .text(function(d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });</td></tr><tr><td class="line-number" value="109"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="110"></td><td class="line-content">  var node = svg.append("g").selectAll(".node")</td></tr><tr><td class="line-number" value="111"></td><td class="line-content">      .data(energy.nodes)</td></tr><tr><td class="line-number" value="112"></td><td class="line-content">    .enter().append("g")</td></tr><tr><td class="line-number" value="113"></td><td class="line-content">      .attr("class", "node")</td></tr><tr><td class="line-number" value="114"></td><td class="line-content">      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })</td></tr><tr><td class="line-number" value="115"></td><td class="line-content">    .call(d3.behavior.drag()</td></tr><tr><td class="line-number" value="116"></td><td class="line-content">      .origin(function(d) { return d; })</td></tr><tr><td class="line-number" value="117"></td><td class="line-content">      .on("dragstart", function() { this.parentNode.appendChild(this); })</td></tr><tr><td class="line-number" value="118"></td><td class="line-content">      .on("drag", dragmove));</td></tr><tr><td class="line-number" value="119"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="120"></td><td class="line-content">  node.append("rect")</td></tr><tr><td class="line-number" value="121"></td><td class="line-content">      .attr("height", function(d) { return d.dy; })</td></tr><tr><td class="line-number" value="122"></td><td class="line-content">      .attr("width", sankey.nodeWidth())</td></tr><tr><td class="line-number" value="123"></td><td class="line-content">      .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })</td></tr><tr><td class="line-number" value="124"></td><td class="line-content">      .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })</td></tr><tr><td class="line-number" value="125"></td><td class="line-content">    .append("title")</td></tr><tr><td class="line-number" value="126"></td><td class="line-content">      .text(function(d) { return d.name + "\n" + format(d.value); });</td></tr><tr><td class="line-number" value="127"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="128"></td><td class="line-content">  node.append("text")</td></tr><tr><td class="line-number" value="129"></td><td class="line-content">      .attr("x", -6)</td></tr><tr><td class="line-number" value="130"></td><td class="line-content">      .attr("y", function(d) { return d.dy / 2; })</td></tr><tr><td class="line-number" value="131"></td><td class="line-content">      .attr("dy", ".35em")</td></tr><tr><td class="line-number" value="132"></td><td class="line-content">      .attr("text-anchor", "end")</td></tr><tr><td class="line-number" value="133"></td><td class="line-content">      .attr("transform", null)</td></tr><tr><td class="line-number" value="134"></td><td class="line-content">      .text(function(d) { return d.name; })</td></tr><tr><td class="line-number" value="135"></td><td class="line-content">    .filter(function(d) { return d.x &lt; width / 2; })</td></tr><tr><td class="line-number" value="136"></td><td class="line-content">      .attr("x", 6 + sankey.nodeWidth())</td></tr><tr><td class="line-number" value="137"></td><td class="line-content">      .attr("text-anchor", "start");</td></tr><tr><td class="line-number" value="138"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="139"></td><td class="line-content">  function dragmove(d) {</td></tr><tr><td class="line-number" value="140"></td><td class="line-content">    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");</td></tr><tr><td class="line-number" value="141"></td><td class="line-content">    sankey.relayout();</td></tr><tr><td class="line-number" value="142"></td><td class="line-content">    link.attr("d", path);</td></tr><tr><td class="line-number" value="143"></td><td class="line-content">  }</td></tr><tr><td class="line-number" value="144"></td><td class="line-content">});</td></tr><tr><td class="line-number" value="145"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="146"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="147"></td><td class="line-content"><span class="html-tag">&lt;script&gt;</span></td></tr><tr><td class="line-number" value="148"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="149"></td><td class="line-content">GoogleAnalyticsObject = "ga", ga = function() { ga.q.push(arguments); }, ga.q = [], ga.l = +new Date;</td></tr><tr><td class="line-number" value="150"></td><td class="line-content">ga("create", "UA-48272912-3", "ocks.org");</td></tr><tr><td class="line-number" value="151"></td><td class="line-content">ga("send", "pageview");</td></tr><tr><td class="line-number" value="152"></td><td class="line-content"><br></td></tr><tr><td class="line-number" value="153"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="154"></td><td class="line-content"><span class="html-tag">&lt;script <span class="html-attribute-name">async</span> <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://www.google-analytics.com/analytics.js">//www.google-analytics.com/analytics.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="155"></td><td class="line-content"><span class="html-end-of-file"></span></td></tr></tbody></table></body></html>